name: Generate Release Notes

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to generate release notes for'
        required: true
        default: 'v1.0.0'

jobs:
  generate-notes:
    runs-on: ubuntu-latest
    outputs:
      release-notes: ${{ steps.generate.outputs.notes }}
      previous-tag: ${{ steps.get-tags.outputs.previous }}
      current-tag: ${{ steps.get-tags.outputs.current }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get tags
      id: get-tags
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          CURRENT_TAG="${{ github.event.inputs.tag }}"
        else
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
        fi
        
        echo "current=$CURRENT_TAG" >> $GITHUB_OUTPUT
        
        # è·å–å‰ä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "")
        if [ -z "$PREVIOUS_TAG" ]; then
          PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "previous=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
        echo "å½“å‰æ ‡ç­¾: $CURRENT_TAG"
        echo "å‰ä¸€ä¸ªæ ‡ç­¾: $PREVIOUS_TAG"
    
    - name: Generate comprehensive release notes
      id: generate
      run: |
        CURRENT_TAG="${{ steps.get-tags.outputs.current }}"
        PREVIOUS_TAG="${{ steps.get-tags.outputs.previous }}"
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        cat > release-notes.md << 'EOF'
        # ğŸ‰ envm ${{ steps.get-tags.outputs.current }} å‘å¸ƒ
        
        æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å¯¹ envm é¡¹ç›®çš„æ”¯æŒï¼è¿™ä¸ªç‰ˆæœ¬åŒ…å«äº†è®¸å¤šæ”¹è¿›å’Œæ–°åŠŸèƒ½ã€‚
        
        ## ğŸ“¦ å®‰è£…æ–¹æ³•
        
        ### Windows ç”¨æˆ·
        
        #### ğŸ¯ æ–¹å¼1ï¼šEXEå®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
        1. ä¸‹è½½ `envm-installer-${{ steps.get-tags.outputs.current }}.exe`
        2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
        3. é€‰æ‹©å®‰è£…è·¯å¾„å’Œç»„ä»¶
        4. å®Œæˆå®‰è£…ï¼ˆè‡ªåŠ¨é…ç½®ç¯å¢ƒå˜é‡ï¼‰
        
        #### ğŸ’¾ æ–¹å¼2ï¼šä¾¿æºç‰ˆ
        1. ä¸‹è½½ `envm-${{ steps.get-tags.outputs.current }}-windows-amd64.zip`
        2. è§£å‹åˆ°ä»»æ„ç›®å½•
        3. æ‰‹åŠ¨æ·»åŠ åˆ°ç³»ç»Ÿ PATH
        
        #### ğŸš€ æ–¹å¼3ï¼šä¸€é”®å®‰è£…è„šæœ¬
        ```powershell
        Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/FirewineXie/envm/main/install.ps1" -UseBasicParsing).Content
        ```
        
        ### Linux/macOS ç”¨æˆ·
        
        #### ğŸš€ ä¸€é”®å®‰è£…
        ```bash
        curl -fsSL https://raw.githubusercontent.com/FirewineXie/envm/main/install.sh | bash
        ```
        
        #### ğŸ“¦ æ‰‹åŠ¨å®‰è£…
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶ï¼š
           - Linux AMD64: `envm-${{ steps.get-tags.outputs.current }}-linux-amd64.tar.gz`
           - Linux ARM64: `envm-${{ steps.get-tags.outputs.current }}-linux-arm64.tar.gz`
           - macOS AMD64: `envm-${{ steps.get-tags.outputs.current }}-darwin-amd64.tar.gz`
           - macOS ARM64: `envm-${{ steps.get-tags.outputs.current }}-darwin-arm64.tar.gz`
        2. è§£å‹å¹¶å®‰è£…åˆ° `/usr/local/bin`
        
        ## âœ¨ ä¸»è¦ç‰¹æ€§
        
        - ğŸ¯ **å¤šå¹³å°æ”¯æŒ**: Windows, Linux, macOS
        - ğŸ”§ **æ™ºèƒ½ç‰ˆæœ¬ç®¡ç†**: è‡ªåŠ¨ä¸‹è½½å’Œåˆ‡æ¢ Go ç‰ˆæœ¬
        - âš¡ **å¿«é€Ÿåˆ‡æ¢**: ç±»ä¼¼ nvm çš„ä½¿ç”¨ä½“éªŒ
        - ğŸ›¡ï¸ **å®‰å…¨å¯é **: è‡ªåŠ¨éªŒè¯ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§
        - ğŸ“ **çµæ´»é…ç½®**: æ”¯æŒè‡ªå®šä¹‰ä¸‹è½½æºå’Œå®‰è£…è·¯å¾„
        
        EOF
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        echo "" >> release-notes.md
        echo "## ğŸ“ æœ¬æ¬¡æ›´æ–°å†…å®¹" >> release-notes.md
        echo "" >> release-notes.md
        
        # è·å–æ–°åŠŸèƒ½
        echo "### ğŸš€ æ–°åŠŸèƒ½ (New Features)" >> release-notes.md
        git log $PREVIOUS_TAG..$CURRENT_TAG --oneline --grep="feat:" --grep="feature:" --grep="æ–°å¢" --grep="æ·»åŠ " --grep="âœ¨" | sed 's/^/- /' >> release-notes.md || echo "- æ— æ–°åŠŸèƒ½" >> release-notes.md
        echo "" >> release-notes.md
        
        # è·å–é”™è¯¯ä¿®å¤
        echo "### ğŸ› é”™è¯¯ä¿®å¤ (Bug Fixes)" >> release-notes.md
        git log $PREVIOUS_TAG..$CURRENT_TAG --oneline --grep="fix:" --grep="ä¿®å¤" --grep="bugfix" --grep="ğŸ›" | sed 's/^/- /' >> release-notes.md || echo "- æ— é”™è¯¯ä¿®å¤" >> release-notes.md
        echo "" >> release-notes.md
        
        # è·å–æ”¹è¿›ä¼˜åŒ–
        echo "### âœ¨ æ”¹è¿›ä¼˜åŒ– (Improvements)" >> release-notes.md
        git log $PREVIOUS_TAG..$CURRENT_TAG --oneline --grep="improve:" --grep="refactor:" --grep="ä¼˜åŒ–" --grep="æ”¹è¿›" --grep="é‡æ„" --grep="â™»ï¸" --grep="âš¡" | sed 's/^/- /' >> release-notes.md || echo "- æ— æ”¹è¿›ä¼˜åŒ–" >> release-notes.md
        echo "" >> release-notes.md
        
        # è·å–æ–‡æ¡£æ›´æ–°
        echo "### ğŸ“š æ–‡æ¡£æ›´æ–° (Documentation)" >> release-notes.md
        git log $PREVIOUS_TAG..$CURRENT_TAG --oneline --grep="docs:" --grep="doc:" --grep="æ–‡æ¡£" --grep="readme" --grep="ğŸ“š" | sed 's/^/- /' >> release-notes.md || echo "- æ— æ–‡æ¡£æ›´æ–°" >> release-notes.md
        echo "" >> release-notes.md
        
        # è·å–æ‰€æœ‰æäº¤ï¼ˆå…¶ä»–ç±»å‹ï¼‰
        echo "### ğŸ”§ å…¶ä»–å˜æ›´ (Other Changes)" >> release-notes.md
        OTHER_COMMITS=$(git log $PREVIOUS_TAG..$CURRENT_TAG --oneline --invert-grep --grep="feat:" --grep="fix:" --grep="docs:" --grep="improve:" --grep="refactor:" --grep="æ–°å¢" --grep="ä¿®å¤" --grep="æ–‡æ¡£" --grep="ä¼˜åŒ–" --grep="æ”¹è¿›" --grep="âœ¨" --grep="ğŸ›" --grep="ğŸ“š" --grep="â™»ï¸" --grep="âš¡" | head -10)
        if [ ! -z "$OTHER_COMMITS" ]; then
          echo "$OTHER_COMMITS" | sed 's/^/- /' >> release-notes.md
        else
          echo "- æ— å…¶ä»–å˜æ›´" >> release-notes.md
        fi
        echo "" >> release-notes.md
        
        # ç›¸å…³ Issues å’Œ PRs
        echo "## ğŸ”— ç›¸å…³é—®é¢˜å’Œæ‹‰å–è¯·æ±‚" >> release-notes.md
        echo "" >> release-notes.md
        ISSUES=$(git log $PREVIOUS_TAG..$CURRENT_TAG --oneline | grep -oE "#[0-9]+" | sort -u | head -10)
        if [ ! -z "$ISSUES" ]; then
          for issue in $ISSUES; do
            echo "- $issue" >> release-notes.md
          done
        else
          echo "- æ— ç›´æ¥å…³è”çš„ Issues æˆ– PRs" >> release-notes.md
        fi
        echo "" >> release-notes.md
        
        # è´¡çŒ®è€…
        echo "## ğŸ‘¥ è´¡çŒ®è€… (Contributors)" >> release-notes.md
        echo "" >> release-notes.md
        echo "æ„Ÿè°¢ä»¥ä¸‹è´¡çŒ®è€…ä¸ºæœ¬ç‰ˆæœ¬åšå‡ºçš„è´¡çŒ®ï¼š" >> release-notes.md
        echo "" >> release-notes.md
        git log $PREVIOUS_TAG..$CURRENT_TAG --format='%an <%ae>' | sort | uniq | while read contributor; do
          echo "- $contributor" >> release-notes.md
        done
        echo "" >> release-notes.md
        
        # ç‰ˆæœ¬ç»Ÿè®¡
        echo "## ğŸ“Š ç‰ˆæœ¬ç»Ÿè®¡" >> release-notes.md
        echo "" >> release-notes.md
        COMMIT_COUNT=$(git rev-list --count $PREVIOUS_TAG..$CURRENT_TAG)
        FILES_CHANGED=$(git diff --stat $PREVIOUS_TAG..$CURRENT_TAG | tail -1 | grep -oE '[0-9]+ files? changed' | grep -oE '[0-9]+' || echo "0")
        INSERTIONS=$(git diff --stat $PREVIOUS_TAG..$CURRENT_TAG | tail -1 | grep -oE '[0-9]+ insertions?' | grep -oE '[0-9]+' || echo "0")
        DELETIONS=$(git diff --stat $PREVIOUS_TAG..$CURRENT_TAG | tail -1 | grep -oE '[0-9]+ deletions?' | grep -oE '[0-9]+' || echo "0")
        
        echo "- ğŸ“ **æäº¤æ•°é‡**: $COMMIT_COUNT" >> release-notes.md
        echo "- ğŸ“ **æ–‡ä»¶å˜æ›´**: $FILES_CHANGED ä¸ªæ–‡ä»¶" >> release-notes.md
        echo "- â• **æ–°å¢ä»£ç **: $INSERTIONS è¡Œ" >> release-notes.md
        echo "- â– **åˆ é™¤ä»£ç **: $DELETIONS è¡Œ" >> release-notes.md
        echo "" >> release-notes.md
        
        # ä½¿ç”¨è¯´æ˜
        echo "## ğŸš€ å¿«é€Ÿå¼€å§‹" >> release-notes.md
        echo "" >> release-notes.md
        echo "å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¼€å§‹ï¼š" >> release-notes.md
        echo "" >> release-notes.md
        echo '```bash' >> release-notes.md
        echo '# æŸ¥çœ‹å¯ç”¨çš„ Go ç‰ˆæœ¬' >> release-notes.md
        echo 'envm list' >> release-notes.md
        echo '' >> release-notes.md
        echo '# å®‰è£… Go 1.21' >> release-notes.md
        echo 'envm install 1.21' >> release-notes.md
        echo '' >> release-notes.md
        echo '# åˆ‡æ¢åˆ° Go 1.21' >> release-notes.md
        echo 'envm use 1.21' >> release-notes.md
        echo '' >> release-notes.md
        echo '# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬' >> release-notes.md
        echo 'envm current' >> release-notes.md
        echo '```' >> release-notes.md
        echo "" >> release-notes.md
        
        # æ”¯æŒä¿¡æ¯
        echo "## ğŸ’¡ è·å–å¸®åŠ©" >> release-notes.md
        echo "" >> release-notes.md
        echo "- ğŸ“– **é¡¹ç›®æ–‡æ¡£**: [README.md](https://github.com/FirewineXie/envm/blob/main/README.md)" >> release-notes.md
        echo "- ğŸ› **æŠ¥å‘Šé—®é¢˜**: [Issues](https://github.com/FirewineXie/envm/issues)" >> release-notes.md
        echo "- ğŸ’¬ **å‚ä¸è®¨è®º**: [Discussions](https://github.com/FirewineXie/envm/discussions)" >> release-notes.md
        echo "- â­ **æ”¯æŒé¡¹ç›®**: ç»™é¡¹ç›®ç‚¹ä¸ªæ˜Ÿæ ‡å§ï¼" >> release-notes.md
        echo "" >> release-notes.md
        
        echo "---" >> release-notes.md
        echo "" >> release-notes.md
        echo "ğŸ¤– *æ­¤å‘å¸ƒè¯´æ˜ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆäº $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> release-notes.md
        
        # ä¿å­˜åˆ°è¾“å‡º
        {
          echo 'notes<<EOF'
          cat release-notes.md
          echo EOF
        } >> $GITHUB_OUTPUT
    
    - name: Upload release notes as artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-notes-${{ steps.get-tags.outputs.current }}
        path: release-notes.md